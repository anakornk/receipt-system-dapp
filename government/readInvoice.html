<html>
  <head>
    <title>Read Invoice</title>
    <script src="../node_modules/web3/dist/web3.min.js"></script>
    <link rel="stylesheet" href="../css/main.css">
  </head>
  <body>
    <div>
      <form id="invoiceForm" action="#">
        <label>
          Invoice id:
          <input id="invoiceId" type="text">
        </label>
        <label>
          Government privateKey (hex: this will not be sent to the server)
          <input id="govPrivKey" type="text" value="ac143d7603c7bd9bd70dd5f69b9486542f95ca37a94aa7ce1941555e2c4be690">
        </label>
        <button type="submit" class="btn btn-default">Submit</button>
      </form>
      <div id="invoice"></div>
    </div>
    <script src="../bundle.js"></script>
    <script src="../contract.js"></script>
    <script>
      var c = require('crypto');
      var BigInteger = require('bigi');
      var ecurve = require('ecurve');
      var Buffer = require('buffer').Buffer;

      var ecparams = ecurve.getCurveByName('secp256k1')

      function startApp(){
        document.querySelector("#invoiceForm").addEventListener('submit',function(e){
          e.preventDefault();
          var invoiceId = new web3.BigNumber(document.querySelector("#invoiceId").value,10);
          ReceiptSystem.getInvoice(invoiceId,function(error,result){
            if(error) return;
            console.log(result);
            var [keySignBC,sharedKeyBC,data] = result;
            var govPrivKey = new Buffer(document.querySelector("#govPrivKey").value, 'hex');
            // get derivedKey
            var sharedKeyBCBuf = new Buffer(keySignBC.slice(2)+sharedKeyBC.slice(2),'hex');
            var curvePoint = ecurve.Point.decodeFrom(ecparams,sharedKeyBCBuf);
            var sharedKeyBCGPoint = curvePoint.multiply(BigInteger.fromBuffer(govPrivKey));
            var sharedKeyBCG = sharedKeyBCGPoint.getEncoded(true);
            var derivedKey = c.pbkdf2Sync(sharedKeyBCG, 'salt', 1, 256, 'sha512');

            var encryptedData = data.join("").replace(/0x/g,'');
            const decipher = c.createDecipher('aes-256-cbc', derivedKey);
            let decrypted = decipher.update(encryptedData, 'hex', 'utf8');
            decrypted += decipher.final('utf8');
            console.log(decrypted);
            document.querySelector("#invoice").innerText = decrypted;
          });

        });
      }





    </script>
  </body>
</html>

