<html>
  <head>
    <title>New Invoice</title>
    <script src="../node_modules/web3/dist/web3.min.js"></script>
    <link rel="stylesheet" href="../css/main.css">
  </head>
  <body>
    <div>
      <form id="addCustomerForm" action="#">
        <label>
          Customer Address(0xABCD)
          <input id="custAddr" type="text" value="0xf4f20eea6eb9dbdd49d20de3f8c2b429cdb3542d">
        </label>
        <label>
          Business privateKey (hex: this will not be sent to the server)
          <input id="busiPrivKey" type="text" value="">
        </label>
        <button type="submit" class="btn btn-default">Submit</button>
      </form>
    </div>
    <script src="../bundle.js"></script>
    <script src="../contract.js"></script>
    <script>
      var BigInteger = require('bigi');
      var ecurve = require('ecurve');
      var Buffer = require('buffer').Buffer;
      var ecparams = ecurve.getCurveByName('secp256k1')
      var c = require('crypto');


      document.querySelector("#addCustomerForm").addEventListener('submit',function(e){
        e.preventDefault();
        var custAddr = new web3.BigNumber(document.querySelector("#custAddr").value,16);
        var busiPrivKey = new Buffer(document.querySelector("#busiPrivKey").value, 'hex');
        var [keySignC,publicKeyC,keySignCG, sharedKeyCG] = ReceiptSystem.getSharedKeyCGData(custAddr);
        // console.log(keySignCG);
        // console.log(sharedKeyCG);
        var sharedKeyCGBuf = new Buffer(keySignCG.slice(2)+sharedKeyCG.slice(2),'hex');
        var curvePoint = ecurve.Point.decodeFrom(ecparams,sharedKeyCGBuf);
        var sharedKeyBCGPoint = curvePoint.multiply(BigInteger.fromBuffer(busiPrivKey));
        var sharedKeyBCG = sharedKeyBCGPoint.getEncoded(true);
        var derivedKey = c.pbkdf2Sync(sharedKeyBCG, 'salt', 1, 256, 'sha512');
        var cipher = c.createCipher('aes-256-cbc',derivedKey);
        var encryptedData = cipher.update('some clear text data', 'utf8','hex');
        encryptedData += cipher.final('hex'); //append block leftovers
        var encryptedByteArray = [];
        for(var i=0;i<encryptedData.length;i=i+2){
          encryptedByteArray.push("0x" + encryptedData[i] + encryptedData[i+1]);
        }
        //encrypted = new web3.BigNumber(encrypted,16);
        console.log(encryptedData);
        console.log(encryptedByteArray);
        // create sharedKeyBC
        var custPubKeyBuf = new Buffer(keySignC.slice(2)+publicKeyC.slice(2),'hex');
        var curvePoint2 = ecurve.Point.decodeFrom(ecparams,custPubKeyBuf);
        var sharedKeyBCPoint = curvePoint2.multiply(BigInteger.fromBuffer(busiPrivKey));
        var sharedKeyBCBuf = sharedKeyBCPoint.getEncoded(true);
        var keySignBC = "0x0" + sharedKeyBCBuf[0];
        var sharedKeyBC = new web3.BigNumber(sharedKeyBCBuf.slice(1).toString('hex'),16);

        // submit
        var egas = ReceiptSystem.newInvoice.estimateGas(custAddr,encryptedByteArray,keySignBC,sharedKeyBC);
        var transId = ReceiptSystem.newInvoice(custAddr,encryptedByteArray,keySignBC,sharedKeyBC,{gas: egas});


        // var custPubKeyBuf = new Buffer(document.querySelector("#custPubKey").value, 'hex');
        // var govPrivKeyBuf = new Buffer(document.querySelector("#govPrivKey").value, 'hex');
        // var curvePoint = ecurve.Point.decodeFrom(ecparams,custPubKeyBuf);
        // //compute shared key between Customer and Government
        // var sharedKeyCGPoint = curvePoint.multiply(BigInteger.fromBuffer(govPrivKeyBuf));
        // var sharedKeyCGBuf = sharedKeyCGPoint.getEncoded(true);
        // var keySignCG =  "0x0" + sharedKeyCGBuf[0];
        // var sharedKeyCG = new web3.BigNumber(sharedKeyCGBuf.slice(1).toString('hex'),16);

        // var keySign = "0x0"+custPubKeyBuf[0];
        // var publicKey = new web3.BigNumber(custPubKeyBuf.slice(1).toString('hex'),16);

        // // submit
        // var egas = ReceiptSystem.addCustomer.estimateGas(custAddr,keySign,publicKey,keySignCG,sharedKeyCG);
        // var transId = ReceiptSystem.addCustomer(custAddr,keySign,publicKey,keySignCG,sharedKeyCG,{gas: egas});
        // console.log(custPubKeyBuf);
        // console.log(sharedKeyCGBuf)
        // console.log(transId);

      });
    </script>
  </body>
</html>
